
- hosts: all
  tasks:
    - name: Update system
      apt:
        update_cache: yes
        upgrade: safe
      become: true

    - name: Install packages via apt
      apt:
        name: "{{ item }}"
        state: present
      with_items:
        - build-essential
        - git
        - mongodb
        - nginx
      become: true

    - name: Pull Node
      get_url: 
        url: https://nodejs.org/dist/v6.9.1/node-v6.9.1-linux-x64.tar.xz
        dest: /home/vagrant

    - name: Extract Node
      unarchive: src=/home/vagrant/node-v6.9.1-linux-x64.tar.xz dest=/home/vagrant remote_src=yes

    - name: Move Node to bin
      copy: src=/home/vagrant/node-v6.9.1-linux-x64/bin/node dest=/usr/local/bin remote_src=yes
      become: true

    - name: Chown node and make executable
      file: path=/usr/local/bin/node owner=vagrant mode="u=rwx,g=rwx,o=rx"
      become: true

    - name: Chown /usr/local/bin
      file: path=/usr/local/bin owner=vagrant state=directory recurse=yes
      become: true

    - name: Chown /usr/local/lib
      file: path=/usr/local/lib owner=vagrant state=directory recurse=yes
      become: true

    - name: Install NPM
      shell: ./npm install -g npm@latest
      args:
        chdir: /home/vagrant/node-v6.9.1-linux-x64/bin

    - name: clone git repo
      git: repo=https://github.com/cla-assistant/cla-assistant.git dest=/home/vagrant/cla-assistant clone=yes

    - name: Create mongodb user
      mongodb_user: database=cla_assistant name=cla_assistant password=cla_assistant state=present

    - name: NPM install
      npm: path=/home/vagrant/cla-assistant

    # Note! This should only be run **IF** we just installed the node_modules.
    - name: build with grunt
      shell: ./node_modules/grunt-cli/bin/grunt build
      args:
        chdir: /home/vagrant/cla-assistant

    - name: Add NGINX configuration for CLA service
      copy: src=files/cla.conf dest=/etc/nginx/conf.d/cla.conf

    # Note! Use this instead, https://docs.ansible.com/ansible/systemd_module.html
    - name: Reload Nginx
      systemd:
        name: nginx
        state: restarted

    - name: Copy .env file
      copy: src=files/cla-assistant.env dest=/home/vagrant/cla-assistant/.env

    - name: Create CLA autostart file
      copy: src=files/cla.service dest=/etc/systemd/system/cla.service
